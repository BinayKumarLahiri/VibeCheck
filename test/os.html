<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PocketWeb OS â€” single-file web OS</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <!-- CodeMirror 5 (for code editor) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

  <!-- Icons (Feather-ish SVG inlined later) -->
  <style>
    :root {
      --bg: #0b1220;
      --accent: #6c8cff;
      --muted: #9aa4b2;
      --panel: #0f1724;
      --glass: rgba(255, 255, 255, 0.03);
      --taskbar: rgba(8, 10, 14, 0.65);
      --glass-2: rgba(255, 255, 255, 0.02);
    }

    * {
      box-sizing: border-box;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, #071322 0%, #00101a 100%);
      overflow: hidden;
      color: #dbe7ff;
    }

    .app-root {
      position: relative;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }

    /* animated star field wallpaper */
    .wallpaper {
      position: absolute;
      inset: 0;
      background: radial-gradient(ellipse at 20% 10%, rgba(108, 140, 255, 0.08), transparent 10%),
        linear-gradient(180deg, rgba(10, 14, 28, 0.4), rgba(3, 6, 10, 0.9));
      z-index: 0;
      pointer-events: none;
    }

    .wallpaper .stars {
      position: absolute;
      inset: 0;
      mix-blend-mode: screen;
      opacity: 0.7;
    }

    /* desktop icons */
    .desktop {
      position: absolute;
      left: 22px;
      top: 22px;
      width: calc(100% - 44px);
      height: calc(100% - 96px);
      z-index: 1;
      padding: 8px;
      overflow: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-content: flex-start;
    }

    .icon {
      width: 88px;
      height: 88px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.06));
      border-radius: 12px;
      padding: 8px;
      color: #dbe7ff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: default;
      box-shadow: 0 6px 20px rgba(2, 4, 8, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.02);
      user-select: none;
      transition: transform .12s ease, box-shadow .12s;
    }

    .icon:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 30px rgba(2, 4, 8, 0.8);
    }

    .icon svg {
      width: 34px;
      height: 34px;
      margin-bottom: 6px;
      opacity: 0.95;
    }

    .icon .label {
      font-size: 12px;
      text-align: center;
      color: var(--muted);
      line-height: 1.1
    }

    /* window manager */
    .win {
      position: absolute;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.06));
      border-radius: 10px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.03);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .win.inactive .titlebar {
      opacity: 0.68;
    }

    .titlebar {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.015), transparent);
      cursor: grab;
    }

    .titlebar:active {
      cursor: grabbing;
    }

    .title {
      flex: 1;
      font-weight: 600;
      font-size: 13px;
      color: #e6f0ff
    }

    .controls {
      display: flex;
      gap: 8px
    }

    .btn {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #072;
      cursor: pointer
    }

    .btn.min {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.03)
    }

    .btn.close {
      background: linear-gradient(180deg, #ff6b6b, #ff3b3b);
      color: #fff
    }

    .content {
      flex: 1;
      padding: 10px;
      overflow: auto;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.01), rgba(0, 0, 0, 0.02));
    }

    /* taskbar */
    .taskbar {
      position: absolute;
      right: 0;
      left: 0;
      bottom: 0;
      height: 56px;
      background: var(--taskbar);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 14px;
      z-index: 50;
      border-top: 1px solid rgba(255, 255, 255, 0.02)
    }

    .start {
      display: flex;
      align-items: center;
      gap: 10px
    }

    .startbtn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), transparent);
      cursor: pointer
    }

    .startbtn strong {
      font-weight: 700
    }

    .task-list {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .task-item {
      min-width: 120px;
      height: 40px;
      background: var(--glass);
      display: flex;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      gap: 8px;
      color: var(--muted);
      cursor: pointer
    }

    .clock {
      min-width: 120px;
      text-align: right;
      color: var(--muted);
      font-weight: 600
    }

    /* start menu */
    .start-menu {
      position: absolute;
      left: 12px;
      bottom: 66px;
      background: linear-gradient(180deg, rgba(7, 11, 20, 0.98), rgba(4, 6, 10, 0.98));
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(1, 2, 6, 0.7);
      width: 360px;
      z-index: 60;
      border: 1px solid rgba(255, 255, 255, 0.03)
    }

    .start-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px
    }

    .app-tile {
      padding: 10px;
      border-radius: 8px;
      background: var(--glass);
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 6px;
      cursor: pointer
    }

    .app-tile small {
      color: var(--muted);
      font-size: 11px
    }

    /* status overlay hints */
    .hint {
      position: absolute;
      right: 20px;
      top: 20px;
      background: linear-gradient(180deg, #071229, #0b1628);
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.02);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      z-index: 70
    }

    /* file manager view */
    .fm-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px
    }

    .fm-item {
      width: 120px;
      height: 120px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.04));
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      justify-content: space-between
    }

    .small {
      font-size: 12px;
      color: var(--muted)
    }

    /* editor */
    textarea,
    input,
    select {
      font-family: Inter, monospace;
      font-size: 13px;
      background: transparent;
      border: 1px dashed rgba(255, 255, 255, 0.03);
      padding: 8px;
      color: #dbe7ff;
      border-radius: 6px
    }

    button.primary {
      background: linear-gradient(90deg, var(--accent), #89b8ff);
      color: #04172a;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer
    }

    /* paint canvas */
    .paint-canvas {
      border-radius: 8px;
      background: #07101a;
      display: block;
      width: 100%;
      height: 480px;
    }

    /* simple responsive */
    @media (max-width:900px) {
      .start-menu {
        width: calc(100% - 36px);
        left: 12px;
        right: 12px
      }

      .desktop {
        left: 12px;
        top: 12px
      }
    }
  </style>
</head>

<body>
  <div class="app-root" id="root">

    <div class="wallpaper" id="wallpaper">
      <canvas id="starfield" class="stars"></canvas>
    </div>

    <div class="desktop" id="desktop"></div>

    <!-- windows container -->
    <div id="windows"></div>

    <!-- start menu (hidden by default) -->
    <div class="start-menu" id="startMenu" style="display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div><strong>PocketWeb OS</strong>
          <div class="small">A single-file creative OS</div>
        </div>
        <div class="small">Local files: <span id="fileCount">0</span></div>
      </div>
      <div class="start-grid" id="startGrid"></div>
      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.02);margin:10px 0">
      <div style="display:flex;gap:8px;justify-content:space-between">
        <input id="quickSearch" placeholder="Search apps or files..."
          style="flex:1;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:#dbe7ff">
        <button class="primary" id="openFilesBtn">Open Files</button>
      </div>
    </div>

    <!-- taskbar -->
    <div class="taskbar">
      <div class="start">
        <div class="startbtn" id="startBtn"><svg width="18" height="18" viewBox="0 0 24 24">
            <path fill="#cfe0ff" d="M3 3h8v8H3zM13 3h8v8h-8zM3 13h8v8H3zM13 13h8v8h-8z"></path>
          </svg><strong>Start</strong></div>
        <div id="taskList" class="task-list"></div>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="hint" id="wifiHint" style="display:none">Network: offline</div>
        <div class="clock" id="clock">--:--</div>
      </div>
    </div>

    <!-- hidden file input -->
    <input type="file" id="filePicker" style="display:none" multiple />

  </div>

  <!-- Load Pyodide (for in-browser Python) -->
  <script>
    // We'll lazy-load pyodide when terminal is first opened.
    window.pyodideLoaded = false;
    window.pyodide = null;
    async function loadPyodideIfNeeded() {
      if (window.pyodideLoaded) return window.pyodide;
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js";
      document.head.appendChild(s);
      await new Promise(resolve => s.onload = resolve);
      // global loadPyodide available now
      window.pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
      window.pyodideLoaded = true;
      return window.pyodide;
    }
  </script>

  <script>
    /* ===========================
       PocketWeb OS â€” main JS
       =========================== */

    const root = document.getElementById('root');
    const desktop = document.getElementById('desktop');
    const windowsEl = document.getElementById('windows');
    const startBtn = document.getElementById('startBtn');
    const startMenu = document.getElementById('startMenu');
    const startGrid = document.getElementById('startGrid');
    const taskList = document.getElementById('taskList');
    const clockEl = document.getElementById('clock');
    const quickSearch = document.getElementById('quickSearch');
    const fileCountEl = document.getElementById('fileCount');
    const openFilesBtn = document.getElementById('openFilesBtn');
    const filePicker = document.getElementById('filePicker');

    let zIndexCounter = 20;
    let winCounter = 0;
    let openWindows = {}; // id => win object

    /* ---------------------------
       Virtual File System (VFS)
       simple JSON in localStorage
       --------------------------- */
    const VFS_KEY = 'pocketweb_vfs_v1';
    let vfs = JSON.parse(localStorage.getItem(VFS_KEY) || '{}');
    function saveVFS() { localStorage.setItem(VFS_KEY, JSON.stringify(vfs)); updateFileCount(); }
    function updateFileCount() { fileCountEl.textContent = Object.keys(vfs).length; }
    function vfsWrite(path, content, meta = {}) {
      vfs[path] = Object.assign({ created: Date.now(), modified: Date.now(), type: 'file', name: path }, meta, { content });
      saveVFS();
    }
    function vfsRead(path) { return vfs[path] ? vfs[path].content : null; }
    function vfsDelete(path) { delete vfs[path]; saveVFS(); }
    function vfsList(prefix = '') { return Object.keys(vfs).filter(k => k.startsWith(prefix)); }
    updateFileCount();

    /* ---------------------------
       Desktop icons & Start Menu
       --------------------------- */
    const APPS = [
      { id: 'txt', name: 'Notepad', desc: 'Simple text editor', icon: 'ðŸ“', fn: openTextEditor },
      { id: 'code', name: 'Code Editor', desc: 'CodeMirror + Run', icon: 'ðŸ’»', fn: openCodeEditor },
      { id: 'term', name: 'Terminal', desc: 'Shell + Python (Pyodide)', icon: 'ðŸ“Ÿ', fn: openTerminal },
      { id: 'paint', name: 'Painter', desc: 'Pixel/Brush painting', icon: 'ðŸŽ¨', fn: openPaint },
      { id: 'game', name: 'Snake', desc: 'Arcade game', icon: 'ðŸ', fn: openGame },
      { id: 'files', name: 'File Manager', desc: 'Browse local files', icon: 'ðŸ“', fn: openFileManager },
      { id: 'video', name: 'Video Editor', desc: 'Trim & export', icon: 'ðŸŽ¬', fn: openVideoEditor },
      { id: 'calc', name: 'Calculator', desc: 'Quick math', icon: 'ðŸ§®', fn: openCalculator },
      { id: 'music', name: 'Music Player', desc: 'Play audio', icon: 'ðŸŽµ', fn: openMusicPlayer },
      { id: 'settings', name: 'Settings', desc: 'Wallpaper, theme', icon: 'âš™ï¸', fn: openSettings }
    ];

    function renderDesktopIcons() {
      desktop.innerHTML = '';
      APPS.forEach(app => {
        const el = document.createElement('div');
        el.className = 'icon';
        el.title = app.name + " â€” " + app.desc;
        el.innerHTML = `<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3" fill="url(#g)"></rect></svg>
      <div class="label">${app.name}</div>`;
        // add nice emoji overlay
        el.querySelector('svg').outerHTML = `<div style="font-size:26px">${app.icon}</div>`;
        el.addEventListener('dblclick', () => app.fn());
        desktop.appendChild(el);
      });
      // Also show quick documents from VFS
      const docs = vfsList('').slice(0, 8);
      docs.forEach(p => {
        const item = document.createElement('div');
        item.className = 'icon';
        item.innerHTML = `<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3" fill="none" stroke="rgba(255,255,255,0.03)"></rect></svg>
      <div class="label">${p}</div>`;
        item.addEventListener('dblclick', () => openTextEditor(p));
        desktop.appendChild(item);
      })
    }
    renderDesktopIcons();

    function renderStartMenu() {
      startGrid.innerHTML = '';
      APPS.forEach(app => {
        const t = document.createElement('div');
        t.className = 'app-tile';
        t.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div style="font-size:20px">${app.icon}</div><div><strong>${app.name}</strong><div class="small">${app.desc}</div></div></div>`;
        t.onclick = () => { app.fn(); toggleStart(false); };
        startGrid.appendChild(t);
      });
    }
    renderStartMenu();

    /* ---------------------------
       Utilities: create Window
       --------------------------- */
    function createWindow({ title = 'Window', width = 640, height = 360, left = 120, top = 80, appId = '', z = null, closable = true, content = null, onfocus = null }) {
      const id = 'win-' + (++winCounter);
      const el = document.createElement('div');
      el.className = 'win';
      el.id = id;
      el.style.width = width + 'px';
      el.style.height = height + 'px';
      el.style.left = left + 'px';
      el.style.top = top + 'px';
      el.style.zIndex = z || (++zIndexCounter);
      el.innerHTML = `
    <div class="titlebar"><div class="title">${title}</div>
      <div class="controls">${closable ? '<div class="btn close" data-act="close">Ã—</div>' : ''}<div class="btn min" data-act="min">â€”</div></div>
    </div>
    <div class="content"></div>
  `;
      windowsEl.appendChild(el);
      const contentEl = el.querySelector('.content');
      if (typeof content === 'string') contentEl.innerHTML = content;
      else if (typeof content === 'function') content(contentEl);
      else if (content instanceof Node) contentEl.appendChild(content);
      // bring to front on mousedown
      el.addEventListener('mousedown', () => focusWindow(id));
      // wire controls
      el.querySelectorAll('[data-act]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const act = btn.getAttribute('data-act');
          if (act === 'close') closeWindow(id);
          if (act === 'min') minimizeWindow(id);
        });
      });
      // make draggable by titlebar
      const tb = el.querySelector('.titlebar');
      tb.addEventListener('mousedown', (ev) => {
        ev.preventDefault();
        const startX = ev.clientX, startY = ev.clientY;
        const origLeft = el.offsetLeft, origTop = el.offsetTop;
        function onMove(e) {
          el.style.left = (origLeft + e.clientX - startX) + 'px';
          el.style.top = (origTop + e.clientY - startY) + 'px';
        }
        function done() {
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', done);
        }
        document.addEventListener('mousemove', onMove);
        document.addEventListener('mouseup', done);
      });
      // simple resize handle
      const resizeGrip = document.createElement('div');
      resizeGrip.style.position = 'absolute'; resizeGrip.style.right = '6px'; resizeGrip.style.bottom = '6px';
      resizeGrip.style.width = '16px'; resizeGrip.style.height = '16px'; resizeGrip.style.cursor = 'nwse-resize';
      el.appendChild(resizeGrip);
      resizeGrip.addEventListener('mousedown', (ev) => {
        ev.preventDefault();
        const sx = ev.clientX, sy = ev.clientY, ow = el.offsetWidth, oh = el.offsetHeight;
        function onMove(e) {
          el.style.width = Math.max(300, ow + e.clientX - sx) + 'px';
          el.style.height = Math.max(180, oh + e.clientY - sy) + 'px';
        }
        function done() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', done); }
        document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', done);
      });
      // store
      openWindows[id] = { id, el, title, appId, minimized: false };
      addToTaskbar(id, title);
      focusWindow(id);
      if (onfocus) onfocus(el);
      return id;
    }

    function focusWindow(id) {
      if (!openWindows[id]) return;
      // lower other windows a touch
      Object.values(openWindows).forEach(w => {
        w.el.classList.add('inactive');
      });
      const w = openWindows[id];
      w.el.classList.remove('inactive');
      w.el.style.zIndex = ++zIndexCounter;
      // highlight task
      document.querySelectorAll('.task-item').forEach(t => t.classList.remove('active'));
      const t = document.querySelector(`.task-item[data-win="${id}"]`);
      if (t) t.classList.add('active');
    }

    function closeWindow(id) {
      if (!openWindows[id]) return;
      const w = openWindows[id];
      try { w.el.remove(); } catch (e) { }
      const t = document.querySelector(`.task-item[data-win="${id}"]`);
      if (t) t.remove();
      delete openWindows[id];
    }
    function minimizeWindow(id) {
      if (!openWindows[id]) return;
      const w = openWindows[id]; w.minimized = true;
      w.el.style.display = 'none';
      const t = document.querySelector(`.task-item[data-win="${id}"]`);
      if (t) t.classList.remove('active');
    }
    function restoreWindow(id) {
      if (!openWindows[id]) return;
      const w = openWindows[id]; w.minimized = false;
      w.el.style.display = 'block';
      focusWindow(id);
    }
    function addToTaskbar(id, title) {
      const el = document.createElement('div'); el.className = 'task-item'; el.dataset.win = id; el.textContent = title;
      el.onclick = () => {
        const w = openWindows[id];
        if (!w) return;
        if (w.minimized) restoreWindow(id);
        else { // bring to front or minimize
          const topZ = parseInt(w.el.style.zIndex || 0);
          if (topZ === zIndexCounter) minimizeWindow(id);
          else focusWindow(id);
        }
      };
      taskList.appendChild(el);
    }

    /* ---------------------------
       Start button & clock
       --------------------------- */
    startBtn.addEventListener('click', () => toggleStart());
    function toggleStart(show) {
      if (typeof show === 'undefined') show = startMenu.style.display === 'none';
      startMenu.style.display = show ? 'block' : 'none';
      if (show) quickSearch.focus();
    }
    setInterval(() => {
      const d = new Date(); clockEl.textContent = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }, 1000);

    /* ---------------------------
       Quick Search
       --------------------------- */
    quickSearch.addEventListener('input', () => {
      const q = quickSearch.value.trim().toLowerCase();
      Array.from(startGrid.children).forEach(tile => {
        const txt = tile.innerText.toLowerCase();
        tile.style.display = txt.includes(q) ? 'block' : 'none';
      })
    });
    openFilesBtn.addEventListener('click', () => { toggleStart(false); openFileManager(); });

    /* ---------------------------
       Wallpaper / starfield effect
       --------------------------- */
    (function starfieldInit() {
      const canvas = document.getElementById('starfield');
      const ctx = canvas.getContext('2d');
      function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
      window.addEventListener('resize', resize); resize();
      const stars = [];
      for (let i = 0; i < 220; i++) {
        stars.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, z: Math.random() * 1.2 + 0.2, s: Math.random() * 1.2 });
      }
      let t = 0;
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let s of stars) {
          const vx = Math.cos((s.x + s.y + t * 10) / 1500) * 0.2;
          const vy = Math.sin((s.y + s.s + t * 8) / 1600) * 0.2;
          s.x += vx; s.y += vy;
          const g = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, Math.max(1, 6 * s.z));
          g.addColorStop(0, 'rgba(140,170,255,' + (0.3 * s.z) + ')');
          g.addColorStop(1, 'rgba(10,20,40,0)');
          ctx.fillStyle = g; ctx.beginPath(); ctx.arc(s.x, s.y, 1.6 * s.s * s.z, 0, Math.PI * 2); ctx.fill();
          // wrap
          if (s.x < 0) s.x = canvas.width;
          if (s.x > canvas.width) s.x = 0;
          if (s.y < 0) s.y = canvas.height;
          if (s.y > canvas.height) s.y = 0;
        }
        t += 0.002;
        requestAnimationFrame(draw);
      }
      draw();
    })();

    /* ===========================
       Applications (functions)
       Each app opens a window and wires interactions
       =========================== */

    /* Notepad / Text Editor */
    function openTextEditor(filename) {
      const name = filename || `untitled-${Date.now().toString(36).slice(-4)}.txt`;
      const id = createWindow({
        title: `Notepad â€” ${name}`, width: 740, height: 520, left: 120, top: 90, appId: 'txt', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="primary" id="saveBtn">Save</button>
        <button id="saveAsBtn">Save As</button>
        <button id="openBtn">Open File</button>
        <div style="flex:1"></div>
        <div class="small" id="status">Editing ${name}</div>
      </div>
      <textarea id="txtArea" style="height:420px;width:100%;resize:vertical"></textarea>
    `;
          const textarea = contentEl.querySelector('#txtArea');
          // load if exists
          const existing = vfsRead(name);
          if (existing !== null) textarea.value = existing;
          // wire buttons
          contentEl.querySelector('#saveBtn').addEventListener('click', () => {
            vfsWrite(name, textarea.value, { name });
            alert('Saved to VFS: ' + name);
            renderDesktopIcons();
          });
          contentEl.querySelector('#saveAsBtn').addEventListener('click', () => {
            const newName = prompt('Save as filename', name) || name;
            vfsWrite(newName, textarea.value, { name: newName });
            alert('Saved as ' + newName);
            renderDesktopIcons();
          });
          contentEl.querySelector('#openBtn').addEventListener('click', () => { openFileDialogFor(textarea); });
        }
      });
    }

    /* Code Editor (CodeMirror) */
    function openCodeEditor(filename) {
      const name = filename || `script-${Date.now().toString(36).slice(-4)}.py`;
      const id = createWindow({
        title: `Code Editor â€” ${name}`, width: 900, height: 600, left: 160, top: 100, appId: 'code', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <select id="langSelect"><option value="python">Python</option><option value="javascript">JavaScript</option></select>
        <button class="primary" id="runBtn">Run</button>
        <button id="saveBtn">Save</button>
        <button id="openBtn">Open</button>
        <div style="flex:1"></div>
        <div class="small" id="runtimeLabel">No runtime loaded</div>
      </div>
      <div style="display:flex;gap:10px">
        <div style="flex:1">
          <textarea id="codeArea"></textarea>
        </div>
        <div style="width:320px;background:var(--panel);padding:8px;border-radius:8px">
          <div style="font-weight:700">Output</div>
          <pre id="codeOut" style="height:420px;overflow:auto;background:transparent;border-radius:6px;padding:8px"></pre>
        </div>
      </div>
    `;
          const ta = contentEl.querySelector('#codeArea');
          ta.value = vfsRead(name) || "# Write code here\nprint('Hello from PocketWeb OS')";
          // init CodeMirror
          const cm = CodeMirror.fromTextArea(ta, { lineNumbers: true, theme: 'material-darker', mode: 'python', viewportMargin: Infinity });
          contentEl.querySelector('#langSelect').addEventListener('change', (e) => {
            const mode = e.target.value === 'python' ? 'python' : 'javascript';
            cm.setOption('mode', mode);
          });
          contentEl.querySelector('#saveBtn').addEventListener('click', () => { vfsWrite(name, cm.getValue(), { name }); alert('Saved: ' + name); renderDesktopIcons(); });
          contentEl.querySelector('#openBtn').addEventListener('click', () => openFileDialogFor(cm));
          const out = contentEl.querySelector('#codeOut');
          // run button â€” supports python via pyodide and JS natively
          contentEl.querySelector('#runBtn').addEventListener('click', async () => {
            const lang = contentEl.querySelector('#langSelect').value;
            out.textContent = '';
            if (lang === 'javascript') {
              try {
                const res = eval(cm.getValue());
                if (res !== undefined) out.textContent = String(res);
              } catch (err) { out.textContent = String(err); }
            } else {
              // ensure pyodide
              contentEl.querySelector('#runtimeLabel').textContent = 'Loading Pyodide...';
              await loadPyodideIfNeeded();
              contentEl.querySelector('#runtimeLabel').textContent = 'Pyodide ready';
              try {
                const result = await window.pyodide.runPythonAsync(cm.getValue());
                if (result !== undefined) out.textContent = String(result);
              } catch (err) { out.textContent = String(err); }
            }
          });
        }
      });
    }

    /* Terminal (basic shell + python REPL) */
    function openTerminal() {
      const id = createWindow({
        title: 'Terminal â€” Shell & Python', width: 800, height: 420, left: 200, top: 130, appId: 'term', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="openPy">Start Py REPL</button>
        <button id="clearBtn">Clear</button>
        <div style="flex:1"></div>
        <div class="small">Type 'help' or run Python</div>
      </div>
      <div style="background:#041422;padding:10px;border-radius:8px;height:320px;overflow:auto" id="termOut"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <input id="termIn" placeholder="Enter command (try: echo, ls, cat filename, python, help)" style="flex:1">
        <button class="primary" id="enterBtn">Enter</button>
      </div>
    `;
          const out = contentEl.querySelector('#termOut');
          const input = contentEl.querySelector('#termIn');
          contentEl.querySelector('#clearBtn').addEventListener('click', () => out.innerHTML = '');
          contentEl.querySelector('#openPy').addEventListener('click', async () => {
            out.innerHTML += '<div class="small">Booting Pyodide (Python in browser)...</div>';
            await loadPyodideIfNeeded();
            out.innerHTML += '<div class="small">Pyodide ready. Type Python expressions with "py: <expr>" or open the Code Editor.</div>';
          });
          function writeLine(t) { out.innerHTML += `<div style="margin-bottom:6px">${t}</div>`; out.scrollTop = out.scrollHeight; }
          function handle(cmd) {
            const parts = cmd.split(' ').filter(Boolean);
            if (parts.length === 0) return;
            const c = parts[0];
            if (c === 'help') {
              writeLine('<div class="small">help: echo, ls, cat &lt;file&gt;, rm &lt;file&gt;, write &lt;file&gt; &lt;text&gt;, py: &ltexpr&gt; (python eval), open &ltapp&gt</div>');
            } else if (c === 'echo') writeLine(parts.slice(1).join(' '));
            else if (c === 'ls') { const list = vfsList('').join('  '); writeLine(list || '<i>no files</i>'); }
            else if (c === 'cat') { const p = parts[1]; if (!p) writeLine('Usage: cat filename'); else { const ct = vfsRead(p); writeLine(ct === null ? '<i>file not found</i>' : '<pre>' + escapeHtml(ct) + '</pre>'); } }
            else if (c === 'rm') { const p = parts[1]; if (!p) writeLine('Usage: rm filename'); else { vfsDelete(p); writeLine('deleted ' + p); renderDesktopIcons(); } }
            else if (c === 'write') { const p = parts[1]; if (!p) writeLine('Usage: write filename text'); else { const txt = parts.slice(2).join(' '); vfsWrite(p, txt); writeLine('written ' + p); renderDesktopIcons(); } }
            else if (c === 'open') { const a = parts[1]; if (a === 'files') openFileManager(); else if (a === 'code') openCodeEditor(); else writeLine('Unknown app: ' + a); }
            else if (cmd.startsWith('py:')) {
              const expr = cmd.slice(3).trim();
              (async () => {
                await loadPyodideIfNeeded();
                try {
                  const res = await window.pyodide.runPythonAsync(expr);
                  writeLine(String(res));
                } catch (err) { writeLine('Python error: ' + String(err)); }
              })();
            } else {
              writeLine('Unknown command: ' + cmd);
            }
          }
          contentEl.querySelector('#enterBtn').addEventListener('click', () => { handle(input.value); input.value = ''; });
          input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { handle(input.value); input.value = ''; } });
          // helper
          function escapeHtml(s) { return s.replace(/&/g, '&amp;').replace(/</g, '&lt;'); }
        }
      });
    }

    /* Paint application */
    function openPaint() {
      const id = createWindow({
        title: 'Painter', width: 900, height: 640, left: 220, top: 120, appId: 'paint', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <select id="tool"><option value="brush">Brush</option><option value="line">Line</option><option value="rect">Rect</option><option value="fill">Fill</option></select>
        <input id="color" type="color" value="#ffffff">
        <input id="size" type="range" min="1" max="60" value="6">
        <button id="undoBtn">Undo</button>
        <button id="saveBtn" class="primary">Save PNG</button>
        <div style="flex:1"></div>
        <button id="clearBtn">Clear</button>
      </div>
      <canvas id="paintCanvas" class="paint-canvas"></canvas>
    `;
          const canvas = contentEl.querySelector('#paintCanvas');
          const ctx = canvas.getContext('2d');
          function resize() { canvas.width = contentEl.clientWidth - 20; canvas.height = 480; redraw(); }
          window.addEventListener('resize', resize); resize();
          // state
          let drawing = false, last = { x: 0, y: 0 };
          let history = [];
          function pushHistory() { history.push(canvas.toDataURL()); if (history.length > 20) history.shift(); }
          function undo() { if (history.length) { const img = new Image(); img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); }; img.src = history.pop(); } }
          function redraw() { if (history.length) { const img = new Image(); img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); }; img.src = history[history.length - 1]; } else { ctx.fillStyle = '#041522'; ctx.fillRect(0, 0, canvas.width, canvas.height); } }
          // init bg
          ctx.fillStyle = '#041522'; ctx.fillRect(0, 0, canvas.width, canvas.height);
          pushHistory();
          // events
          canvas.addEventListener('mousedown', (e) => {
            drawing = true; const r = canvas.getBoundingClientRect(); last = { x: e.clientX - r.left, y: e.clientY - r.top };
          });
          canvas.addEventListener('mousemove', (e) => {
            if (!drawing) return;
            const r = canvas.getBoundingClientRect(); const x = e.clientX - r.left, y = e.clientY - r.top;
            const tool = contentEl.querySelector('#tool').value;
            const color = contentEl.querySelector('#color').value;
            const size = +contentEl.querySelector('#size').value;
            if (tool === 'brush') {
              ctx.strokeStyle = color; ctx.lineWidth = size; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(last.x, last.y); ctx.lineTo(x, y); ctx.stroke();
              last = { x, y };
            }
          });
          canvas.addEventListener('mouseup', () => { drawing = false; pushHistory(); });
          contentEl.querySelector('#undoBtn').addEventListener('click', undo);
          contentEl.querySelector('#clearBtn').addEventListener('click', () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = '#041522'; ctx.fillRect(0, 0, canvas.width, canvas.height); pushHistory(); });
          contentEl.querySelector('#saveBtn').addEventListener('click', () => {
            const data = canvas.toDataURL('image/png');
            const name = prompt('Save image as filename.png', 'painting-' + Date.now().toString(36) + '.png');
            if (!name) return;
            vfsWrite(name, data, { type: 'image', name });
            alert('Saved to VFS: ' + name);
            renderDesktopIcons();
          });
        }
      });
    }

    /* Simple Snake Game */
    function openGame() {
      const id = createWindow({
        title: 'Snake â€” arcade', width: 520, height: 520, left: 260, top: 140, appId: 'game', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="startBtn" class="primary">Start</button>
        <button id="pauseBtn">Pause</button>
        <div style="flex:1"></div><div class="small">Arrow keys to move</div>
      </div>
      <canvas id="gameCanvas" width="480" height="420" style="background:#041522;border-radius:8px"></canvas>
    `;
          const canvas = contentEl.querySelector('#gameCanvas');
          const ctx = canvas.getContext('2d');
          const W = 24, H = 18, S = 20;
          let snake, dir, food, running = false, timer = null, score = 0;
          function reset() { snake = [{ x: 8, y: 8 }, { x: 7, y: 8 }, { x: 6, y: 8 }]; dir = { x: 1, y: 0 }; placeFood(); score = 0; draw(); }
          function placeFood() { food = { x: Math.floor(Math.random() * W), y: Math.floor(Math.random() * H) }; }
          function step() {
            const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };
            // wrap edges
            head.x = (head.x + W) % W; head.y = (head.y + H) % H;
            // collision
            if (snake.some(s => s.x === head.x && s.y === head.y)) { gameOver(); return; }
            snake.unshift(head);
            if (head.x === food.x && head.y === food.y) { score += 10; placeFood(); } else snake.pop();
            draw();
          }
          function draw() {
            ctx.fillStyle = '#041522'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            // grid
            for (let x = 0; x < W; x++) { for (let y = 0; y < H; y++) { ctx.fillStyle = (x + y) % 2 ? '#042330' : '#052b3b'; ctx.fillRect(x * S, y * S, S - 1, S - 1); } }
            // food
            ctx.fillStyle = '#ff6b6b'; ctx.fillRect(food.x * S + 3, food.y * S + 3, S - 6, S - 6);
            // snake
            ctx.fillStyle = '#89b8ff'; snake.forEach((s, i) => { ctx.fillRect(s.x * S + 1, s.y * S + 1, S - 2, S - 2); if (i === 0) { ctx.fillStyle = '#cfe0ff'; ctx.fillRect(s.x * S + 4, s.y * S + 4, 6, 6); ctx.fillStyle = '#89b8ff'; } });
            ctx.fillStyle = '#dbe7ff'; ctx.fillText('Score: ' + score, 8, canvas.height - 6);
          }
          function gameOver() { clearInterval(timer); running = false; alert('Game over â€” score ' + score); }
          contentEl.querySelector('#startBtn').addEventListener('click', () => { if (running) return; reset(); timer = setInterval(step, 140); running = true; });
          contentEl.querySelector('#pauseBtn').addEventListener('click', () => { if (running) { clearInterval(timer); running = false; } else { timer = setInterval(step, 140); running = true; } });
          window.addEventListener('keydown', (e) => {
            if (!['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) return;
            if (e.key === 'ArrowUp' && dir.y === 0) dir = { x: 0, y: -1 };
            if (e.key === 'ArrowDown' && dir.y === 0) dir = { x: 0, y: 1 };
            if (e.key === 'ArrowLeft' && dir.x === 0) dir = { x: -1, y: 0 };
            if (e.key === 'ArrowRight' && dir.x === 0) dir = { x: 1, y: 0 };
          });
          reset();
        }
      });
    }

    /* File Manager */
    function openFileManager() {
      const id = createWindow({
        title: 'File Manager', width: 920, height: 560, left: 140, top: 100, appId: 'files', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button id="newTxt" class="primary">New Text File</button>
        <button id="upload">Upload Files</button>
        <button id="downloadSel">Download Selected</button>
        <button id="deleteSel">Delete Selected</button>
        <input id="filter" placeholder="Filter filename..." style="margin-left:8px">
        <div style="flex:1"></div>
        <div class="small" id="selCount">0 selected</div>
      </div>
      <div class="fm-list" id="fmList" style="height:440px;overflow:auto"></div>
    `;
          const fmList = contentEl.querySelector('#fmList');
          const selCount = contentEl.querySelector('#selCount');
          function render() {
            fmList.innerHTML = ''; const files = vfsList('').sort((a, b) => a.localeCompare(b));
            files.forEach(p => {
              const meta = vfs[p] || {};
              const it = document.createElement('div'); it.className = 'fm-item';
              it.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">${p}</div><div class="small">${formatDate(meta.modified)}</div></div>
          <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
            <div class="small">${(meta.type === 'image' ? 'Image' : (meta.type || 'File'))}</div>
            <div>
              <button data-open="${p}">Open</button>
              <button data-dl="${p}">Download</button>
              <input type="checkbox" data-select="${p}">
            </div>
          </div>`;
              fmList.appendChild(it);
            });
            // wire
            fmList.querySelectorAll('[data-open]').forEach(b => b.addEventListener('click', (e) => {
              const p = e.target.getAttribute('data-open');
              if ((vfs[p] || {}).type === 'image') { openImageViewer(p); }
              else openTextEditor(p);
            }));
            fmList.querySelectorAll('[data-dl]').forEach(b => b.addEventListener('click', (e) => {
              const p = e.target.getAttribute('data-dl'); downloadFromVFS(p);
            }));
            fmList.querySelectorAll('[data-select]').forEach(cb => cb.addEventListener('change', () => updateSelCount()));
            updateSelCount();
          }
          function updateSelCount() {
            const count = fmList.querySelectorAll('[data-select]:checked').length; selCount.textContent = count + ' selected';
          }
          // buttons
          contentEl.querySelector('#newTxt').addEventListener('click', () => {
            const name = prompt('Filename', 'note-' + Date.now().toString(36) + '.txt'); if (!name) return;
            vfsWrite(name, ''); render(); renderDesktopIcons();
          });
          contentEl.querySelector('#upload').addEventListener('click', () => { filePicker.click(); });
          filePicker.onchange = (ev) => {
            Array.from(ev.target.files).forEach(file => {
              const reader = new FileReader();
              reader.onload = (e) => { const content = e.target.result; vfsWrite(file.name, content, { type: 'binary', name: file.name }); render(); renderDesktopIcons(); };
              // read as dataURL for images and binaries, text for text
              if (file.type.startsWith('text') || file.name.endsWith('.js') || file.name.endsWith('.py')) reader.readAsText(file);
              else reader.readAsDataURL(file);
            });
            filePicker.value = '';
          };
          contentEl.querySelector('#deleteSel').addEventListener('click', () => {
            const sels = Array.from(fmList.querySelectorAll('[data-select]:checked')).map(cb => cb.getAttribute('data-select'));
            if (!sels.length) return alert('No files selected');
            if (!confirm('Delete ' + sels.length + ' files?')) return;
            sels.forEach(p => vfsDelete(p)); render(); renderDesktopIcons();
          });
          contentEl.querySelector('#downloadSel').addEventListener('click', () => {
            const sels = Array.from(fmList.querySelectorAll('[data-select]:checked')).map(cb => cb.getAttribute('data-select'));
            if (!sels.length) return alert('No files selected');
            sels.forEach(p => downloadFromVFS(p));
          });
          contentEl.querySelector('#filter').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            fmList.querySelectorAll('.fm-item').forEach(it => {
              const name = it.querySelector('div').innerText.toLowerCase();
              it.style.display = name.includes(q) ? 'block' : 'none';
            });
          });
          render();

          // helper functions for open/download
          function openImageViewer(path) {
            const meta = vfs[path]; if (!meta) return;
            createWindow({ title: 'Image â€” ' + path, width: 640, height: 520, left: 180, top: 160, content: (c) => { c.innerHTML = `<div style="padding:6px"><img src="${meta.content}" style="max-width:100%;border-radius:6px"></div>`; } });
          }
          function downloadFromVFS(path) {
            const meta = vfs[path]; if (!meta) return alert('File not found');
            const a = document.createElement('a');
            if (meta.type === 'image' || (typeof meta.content === 'string' && meta.content.startsWith('data:'))) {
              a.href = meta.content; a.download = path; a.click();
            } else {
              const blob = new Blob([meta.content], { type: 'application/octet-stream' });
              a.href = URL.createObjectURL(blob); a.download = path; a.click();
            }
          }
          function formatDate(ts) { if (!ts) return ''; const d = new Date(ts); return d.toLocaleString(); }
        }
      });
    }

    /* Video Editor â€” trims & exports small clip (limited) */
    function openVideoEditor() {
      const id = createWindow({
        title: 'Video Editor â€” Trim & Export', width: 920, height: 560, left: 180, top: 110, appId: 'video', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input type="file" id="vidImport" accept="video/*">
        <button id="loadSample">Load Sample</button>
        <div style="flex:1"></div>
        <button id="exportBtn" class="primary">Export Clip</button>
      </div>
      <div style="display:flex;gap:12px">
        <video id="editorVideo" controls style="width:60%;border-radius:8px;background:#000"></video>
        <div style="flex:1">
          <div>Start: <input id="startT" type="number" step="0.1" min="0" value="0"></div>
          <div>End: <input id="endT" type="number" step="0.1" min="0" value="5"></div>
          <div style="margin-top:10px">Preview area</div>
          <canvas id="previewCanvas" width="320" height="240" style="background:#000;border-radius:6px"></canvas>
        </div>
      </div>
    `;
          const vid = contentEl.querySelector('#editorVideo');
          const startT = contentEl.querySelector('#startT');
          const endT = contentEl.querySelector('#endT');
          const importEl = contentEl.querySelector('#vidImport');
          const canvas = contentEl.querySelector('#previewCanvas');
          const ctx = canvas.getContext('2d');
          let mediaStream = null, recorder = null, chunks = [];
          importEl.addEventListener('change', () => {
            const f = importEl.files[0]; if (!f) return;
            vid.src = URL.createObjectURL(f); vid.onloadedmetadata = () => { endT.value = Math.min(vid.duration, 5); };
          });
          contentEl.querySelector('#loadSample').addEventListener('click', () => { vid.src = "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4"; vid.onloadedmetadata = () => { endT.value = Math.min(vid.duration, 5); }; });
          // preview drawing current frame
          function drawFrame() { try { ctx.drawImage(vid, 0, 0, canvas.width, canvas.height); } catch (e) { } }
          vid.addEventListener('timeupdate', drawFrame);
          // export: capture played frames from start to end and use MediaRecorder on canvas
          contentEl.querySelector('#exportBtn').addEventListener('click', async () => {
            if (!vid.src) return alert('Load a video first.');
            const s = parseFloat(startT.value) || 0, eT = parseFloat(endT.value) || Math.min(vid.duration, 5);
            if (eT <= s) return alert('End must be after start');
            // use an offscreen canvas and draw frames, then record
            const off = document.createElement('canvas'); off.width = 640; off.height = 360; const offCtx = off.getContext('2d');
            const stream = off.captureStream(30);
            const media = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
            const outChunks = []; media.ondataavailable = ev => outChunks.push(ev.data);
            media.start();
            // seek and play through the clip by drawing frames
            vid.currentTime = s;
            await new Promise(res => vid.pause(), res());
            // draw sequence at ~30fps
            const fps = 30; const frameCount = Math.ceil((eT - s) * fps);
            for (let i = 0; i < frameCount; i++) {
              vid.currentTime = s + i * (1 / fps);
              await new Promise((r) => {
                const onseek = () => { offCtx.drawImage(vid, 0, 0, off.width, off.height); r(); vid.removeEventListener('seeked', onseek); };
                vid.addEventListener('seeked', onseek);
              });
            }
            // stop recorder after short timeout
            await new Promise(r => setTimeout(() => { media.stop(); r(); }, 500));
            media.onstop = () => {
              const blob = new Blob(outChunks, { type: 'video/webm' });
              const name = prompt('Export filename', 'clip-' + Date.now().toString(36) + '.webm');
              if (!name) return;
              const reader = new FileReader();
              reader.onload = () => { vfsWrite(name, reader.result, { type: 'video', name }); alert('Saved to VFS: ' + name); renderDesktopIcons(); };
              reader.readAsDataURL(blob);
            };
          });
        }
      });
    }

    /* Calculator */
    function openCalculator() {
      createWindow({
        title: 'Calculator', width: 300, height: 420, left: 720, top: 130, appId: 'calc', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="calcScreen" readonly style="text-align:right;font-size:22px;padding:10px;height:48px">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px">
          <button>7</button><button>8</button><button>9</button><button>/</button>
          <button>4</button><button>5</button><button>6</button><button>*</button>
          <button>1</button><button>2</button><button>3</button><button>-</button>
          <button>0</button><button>.</button><button>=</button><button>+</button>
        </div>
      </div>
    `;
          const screen = contentEl.querySelector('#calcScreen');
          contentEl.querySelectorAll('button').forEach(b => {
            b.addEventListener('click', () => { const val = b.textContent; if (val === '=') { try { screen.value = eval(screen.value); } catch (e) { screen.value = 'err'; } } else screen.value += val; });
          });
        }
      });
    }

    /* Music Player */
    function openMusicPlayer() {
      createWindow({
        title: 'Music Player', width: 640, height: 420, left: 420, top: 180, appId: 'music', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input type="file" id="mpFile" accept="audio/*">
        <button id="playBtn" class="primary">Play</button>
        <button id="pauseBtn">Pause</button>
        <div style="flex:1"></div>
        <div class="small" id="now">No track</div>
      </div>
      <audio id="audio" controls style="width:100%"></audio>
    `;
          const audio = contentEl.querySelector('#audio');
          contentEl.querySelector('#mpFile').addEventListener('change', (e) => {
            const f = e.target.files[0]; if (!f) return;
            audio.src = URL.createObjectURL(f); contentEl.querySelector('#now').textContent = f.name;
          });
          contentEl.querySelector('#playBtn').addEventListener('click', () => audio.play());
          contentEl.querySelector('#pauseBtn').addEventListener('click', () => audio.pause());
        }
      });
    }

    /* Settings */
    function openSettings() {
      createWindow({
        title: 'Settings', width: 560, height: 420, left: 420, top: 100, appId: 'settings', content: (contentEl) => {
          contentEl.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <div><strong>Wallpaper</strong><div class="small">Animated starfield intensity</div></div>
        <input id="starDensity" type="range" min="0" max="400" value="220">
        <div><strong>Appearance</strong></div>
        <select id="themeSelect"><option value="dark">Dark</option><option value="light">Light</option></select>
        <button id="resetVFS">Reset Local Files</button>
        <div class="small">Tip: Use the terminal to explore VFS with commands: ls, cat, write, rm</div>
      </div>
    `;
          contentEl.querySelector('#resetVFS').addEventListener('click', () => {
            if (confirm('Reset all local files?')) { vfs = {}; saveVFS(); renderDesktopIcons(); alert('VFS reset'); }
          });
          contentEl.querySelector('#themeSelect').addEventListener('change', (e) => {
            if (e.target.value === 'light') document.documentElement.style.setProperty('--bg', '#f6f9ff');
            else document.documentElement.style.removeProperty('--bg');
          });
        }
      });
    }

    /* ===========================
       Helpers
       =========================== */
    function openFileDialogFor(target) {
      // If target is CodeMirror instance or textarea element
      const files = Object.keys(vfs);
      const pick = prompt('Open file from VFS:\n' + files.join('\n') + '\n\nType filename to open');
      if (!pick) return;
      const content = vfsRead(pick);
      if (content === null) return alert('File not found');
      if (target && typeof target.setValue === 'function') target.setValue(content);
      else if (target instanceof HTMLTextAreaElement) target.value = content;
      else if (typeof target === 'function') target(content);
    }

    /* utility download helper */
    function downloadBlob(content, filename) {
      const a = document.createElement('a');
      const blob = (typeof content === 'string' && content.startsWith('data:')) ? null : new Blob([content], { type: 'application/octet-stream' });
      if (blob) {
        a.href = URL.createObjectURL(blob);
      } else {
        a.href = content; // dataURL
      }
      a.download = filename; a.click();
    }

    /* image viewer helper already used elsewhere */

    /* simple escape for terminal output */
    function escapeHtml(s) { return ('' + s).replace(/&/g, '&amp;').replace(/</g, '&lt;'); }

    /* ===========================
       Final polish: keyboard shortcuts
       =========================== */
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'b') { e.preventDefault(); openCodeEditor(); }
      if (e.altKey && e.key === 'f') { e.preventDefault(); openFileManager(); }
      if (e.ctrlKey && e.key === 'p') { e.preventDefault(); openPaint(); }
      if (e.ctrlKey && e.key === 't') { e.preventDefault(); openTerminal(); }
    });

    /* initial hints */
    setTimeout(() => { const hint = document.createElement('div'); hint.className = 'hint'; hint.innerHTML = '<strong>Tip</strong> â€” Double-click desktop icons to open apps. Ctrl+B: Code; Ctrl+P: Paint; Alt+F: Files'; document.body.appendChild(hint); setTimeout(() => hint.remove(), 6000); }, 1200);
  </script>

</body>

</html>